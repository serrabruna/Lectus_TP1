<div class="add-livro-wrapper">
    
    @if (loading()) {
        <div class="mensagem">Carregando dados do livro para edição...</div>
    }
    
    @else if (livro()) {
        
        <div class="form-area">
            <section class="form-container">
                <form #formulario="ngForm" (ngSubmit)="onSave(formulario)" novalidate>
                    <div class="titulo">
                        <h2>Editar Livro: {{ livro()!.titulo }} (ID: {{ livro()!.id }})</h2>
                    </div>
                    
                    <div class="form-grid">
                        <div class="campo campo-full">
                            <label for="titulo">Título: </label>
                            <input type="text" id="titulo" name="titulo"
                                [(ngModel)]="livro()!.titulo" required minlength="3" placeholder="Título do Livro">
                            <small class="erro" [hidden]="!(formulario.controls['titulo']?.dirty && formulario.controls['titulo'].invalid)">
                                O **título** é obrigatório e deve ter ao menos 3 caracteres.
                            </small>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="campo campo-full">
                            <label for="autor">Autor: </label>
                            <input type="text" id="autor" name="autor"
                                [(ngModel)]="livro()!.autor" required minlength="3" placeholder="Nome do Autor">
                            <small class="erro" [hidden]="!(formulario.controls['autor']?.dirty && formulario.controls['autor'].invalid)">
                                O **autor** é obrigatório e deve ter ao menos 3 caracteres.
                            </small>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="campo">
                            <label for="editora">Editora: </label>
                            <input type="text" id="editora" name="editora"
                                [(ngModel)]="livro()!.editora" required placeholder="Editora">
                            <small class="erro" [hidden]="!(formulario.controls['editora']?.dirty && formulario.controls['editora'].invalid)">
                                A **editora** é obrigatória.
                            </small>
                        </div>

                        <div class="campo">
                            <label for="isbn">ISBN: </label>
                            <input type="text" id="isbn" name="isbn"
                                [(ngModel)]="livro()!.isbn" required placeholder="ISBN">
                            <small class="erro" [hidden]="!(formulario.controls['isbn']?.dirty && formulario.controls['isbn'].invalid)">
                                O **ISBN** é obrigatório.
                            </small>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="campo">
                            <label for="preco">Preço: </label>
                            <input type="number" id="preco" name="preco"
                                [(ngModel)]="livro()!.preco" required min="0.01" step="0.01" placeholder="99.90">
                            <small class="erro" [hidden]="!(formulario.controls['preco']?.dirty && formulario.controls['preco'].invalid)">
                                O **preço** é obrigatório e deve ser maior que zero.
                            </small>
                        </div>

                        <div class="campo">
                            <label for="estoque">Estoque Inicial: </label>
                            <input type="number" id="estoque" name="estoque"
                                [(ngModel)]="livro()!.estoque" required min="1" placeholder="10">
                            <small class="erro" [hidden]="!(formulario.controls['estoque']?.dirty && formulario.controls['estoque'].invalid)">
                                O **estoque** é obrigatório e deve ser no mínimo 1.
                            </small>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="campo campo-full">
                            <label for="imageURL">URL da Imagem: </label>
                            <input type="text" id="imageURL" name="imageURL"
                                [(ngModel)]="livro()!.imageURL" required placeholder="http://link-para-imagem.jpg">
                            <small class="erro" [hidden]="!(formulario.controls['imageURL']?.dirty && formulario.controls['imageURL'].invalid)">
                                A **URL da imagem** é obrigatória.
                            </small>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="campo">
                            <label for="data_publicacao">Data de Publicação: </label>
                            <input type="date" id="data_publicacao" name="data_publicacao"
                                [ngModel]="livro()!.data_publicacao | date:'yyyy-MM-dd'" 
                                (ngModelChange)="onDataPublicacaoChange($event)"
                                required>
                            <small class="erro" [hidden]="!(formulario.controls['data_publicacao']?.dirty && formulario.controls['data_publicacao'].invalid)">
                                A **data de publicação** é obrigatória.
                            </small>
                        </div>
                        
                        <div class="campo">
                            <label for="categoria_id">Categoria: </label>
                            <select id="categoria_id" name="categoria_id" 
                                [(ngModel)]="livro()!.categoria_id" required>
                                
                                @for (categoria of categorias(); track categoria.id) {
                                    <option [ngValue]="categoria.id">{{ categoria.nome }}</option>
                                }
                                @empty {
                                    <option [ngValue]="null" disabled>Carregando categorias...</option>
                                }
                            </select>
                            <small class="erro" [hidden]="!(formulario.controls['categoria_id']?.dirty && formulario.controls['categoria_id'].invalid)">
                                A **categoria** é obrigatória.
                            </small>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="campo campo-full">
                            <label for="sinopse">Sinopse: </label>
                            <textarea id="sinopse" name="sinopse"
                                [(ngModel)]="livro()!.sinopse" required minlength="10" rows="5" placeholder="Descrição detalhada do livro..."></textarea>
                            <small class="erro" [hidden]="!(formulario.controls['sinopse']?.dirty && formulario.controls['sinopse'].invalid)">
                                A **sinopse** é obrigatória e deve ter ao menos 10 caracteres.
                            </small>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="campo campo-full checkbox-container">
                            <label for="empromocao">Em Promoção?</label>
                            <input type="checkbox" id="promocao" name="promocao" 
                                    [(ngModel)]="livro()!.promocao">
                        </div>
                    </div>
                    
                    <div class="botoes-formulario">
                        <button type="submit" [disabled]="formulario.invalid || enviando()">
                            {{ enviando() ? 'Salvando...' : 'Salvar Alterações' }}
                        </button>
                    </div>

                    @if (mensagem()) {
                        <p class="mensagem">{{ mensagem() }}</p>
                    }
                </form>
            </section>
        </div>

        <div class="preview-area">
            @if (livro()!.imageURL) {
                <img [src]="livro()!.imageURL" 
                    alt="Pré-visualização da Capa" 
                    class="preview-img">
            } @else {
                <div class="placeholder">
                    Erro ao carregar iamgem do livro
                </div>
            }
        </div>
    }

    @else if (!loading() && !livro() && mensagem()) {
        <div class="mensagem error-message">{{ mensagem() }}</div>
    }
</div>